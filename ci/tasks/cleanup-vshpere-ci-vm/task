#!/usr/bin/env bash

set -x

curl -L -s https://github.com/vmware/govmomi/releases/download/v0.21.0/govc_linux_amd64.gz | gunzip >/usr/local/bin/govc
chmod +x /usr/local/bin/govc

govc ls /Buffalo-Lab/vm/bucc-ci/vms \
    | xargs -L1 govc vm.info -json -vm.ipath=  \
    | jq -r -S --arg=tag=$CLEANUP_VM_TAG '.VirtualMachines
      | map(select(.Value[].Value | contains($tag)))
      | .[].Config.Hardware.Device[].Backing.Parent.Uuid' \
          | grep -v null | xargs govc vm.destroy -vm.uuid= \
          | true

govc ls /Buffalo-Lab/vm/bucc-ci/vms \
    | xargs -L1 govc vm.info -json -vm.ipath=  \
    | jq -r -S --arg=tag=$CLEANUP_VM_TAG '.VirtualMachines
      | map(select(.Value[].Value | contains($tag)))
      | .[].Config.InstanceUuid' \
          | grep -v null | xargs govc vm.destroy -vm.uuid= \
          | true
